# 批量关闭端口功能使用指南

## 功能简介

批量关闭功能允许你一次性选择多个端口进行关闭，提高操作效率。特别适用于需要同时关闭多个相关服务或清理开发环境时使用。

## 功能特点

- ✅ 支持多选端口
- ✅ 全选/取消全选功能
- ✅ 智能识别系统管理的服务
- ✅ 支持批量"永久停止"
- ✅ 显示详细的操作结果
- ✅ 统计成功和失败数量

---

## 使用步骤

### 方法 1：通过界面批量关闭

#### 步骤1：选择端口

访问 http://localhost:9527，在端口列表中：

1. **单选**: 勾选每行左侧的复选框
2. **全选**: 点击表头的复选框全选所有端口
3. **部分选择**: 勾选特定的几个端口

#### 步骤2：点击批量关闭按钮

- 选中端口后，工具栏会显示"**关闭选中 (N)**"按钮
- N 表示已选中的端口数量
- 点击该按钮

#### 步骤3：确认操作

在弹出的确认对话框中：

```
批量关闭进程

确定要关闭选中的 3 个进程吗？

端口列表:
┌─────────────────────────────────┐
│ 端口 3306  PID: 24883 - mysqld  │
│ 端口 6379  PID: 21176 - redis   │
│ 端口 8080  PID: 12345 - java    │
└─────────────────────────────────┘

如果包含数据库/系统服务:
○ 临时关闭
  仅关闭进程，服务可能会自动重启

● 永久停止（推荐）
  停止系统服务，不会自动重启

[确定关闭] [取消]
```

#### 步骤4：查看结果

操作完成后会显示：
```
批量关闭进程完成: 3 成功
或
批量停止服务完成: 2 成功, 1 失败
```

---

## 使用场景

### 场景 1：清理开发环境

**目标**: 关闭所有开发相关的端口

1. 使用筛选器选择"开发进程: 是"
2. 点击全选复选框
3. 点击"关闭选中"按钮
4. 选择"临时关闭"（因为是开发进程）
5. 确认关闭

**效果**: 一次性关闭所有开发服务器、构建工具等

### 场景 2：停止所有数据库服务

**目标**: 永久停止所有数据库服务

1. 使用"进程类型"筛选器选择"数据库"
2. 点击全选复选框
3. 点击"关闭选中"按钮
4. 选择"**永久停止**"（推荐）
5. 确认关闭

**效果**: MySQL、Redis、PostgreSQL 等数据库服务全部停止且不会重启

### 场景 3：关闭特定端口范围

**目标**: 关闭端口 8000-9000 范围内的服务

1. 在端口列表中手动勾选该范围的端口
2. 或使用搜索功能快速定位
3. 点击"关闭选中"按钮
4. 根据进程类型选择关闭方式
5. 确认关闭

### 场景 4：清理僵尸进程

**目标**: 关闭所有无响应的进程

1. 查看进程列表，识别问题进程
2. 逐个勾选需要清理的进程
3. 批量关闭
4. 刷新验证

---

## API 使用方式

### 批量关闭 API

```bash
curl -X DELETE "http://localhost:9527/api/process/batch" \
  -H "Content-Type: application/json" \
  -d '{
    "pids": [24883, 21176, 12345],
    "permanent": true
  }'
```

### 请求参数

```json
{
  "pids": [24883, 21176],      // 进程ID数组
  "permanent": true             // 是否永久停止（可选，默认false）
}
```

### 响应示例

```json
{
  "success": true,
  "total": 3,
  "successCount": 2,
  "failCount": 1,
  "permanent": true,
  "results": [
    {
      "pid": 24883,
      "success": true,
      "message": "Service stopped permanently"
    },
    {
      "pid": 21176,
      "success": true,
      "message": "Service stopped permanently"
    },
    {
      "pid": 12345,
      "success": false,
      "message": "Process not found or already terminated"
    }
  ]
}
```

---

## 界面说明

### 1. 复选框列

- **位置**: 表格最左侧
- **功能**: 选择要批量关闭的端口
- **状态**:
  - ☐ 未选中
  - ☑ 选中
  - ☑ (半选) - 表头显示，表示部分选中

### 2. 全选复选框

- **位置**: 表头第一列
- **功能**: 
  - 点击一次: 全选所有端口
  - 再次点击: 取消全选
- **状态指示**:
  - 空框: 未选中任何端口
  - 减号: 部分选中
  - 勾选: 全部选中

### 3. 批量关闭按钮

- **位置**: 工具栏右侧
- **显示条件**: 至少选中 1 个端口时显示
- **文本**: "关闭选中 (N)" - N 为选中数量
- **样式**: 红色背景（危险操作提示）

### 4. 批量确认对话框

显示内容：
- 标题："批量关闭进程"
- 选中的端口列表（带滚动条）
- 每个端口显示: 端口号、PID、进程名
- 关闭方式选项（如有系统管理的服务）
- 操作按钮："确定关闭" 和 "取消"

---

## 快捷操作

### 键盘快捷键（未来计划）

- `Ctrl/Cmd + A`: 全选端口
- `Escape`: 取消对话框
- `Enter`: 确认批量关闭（在对话框中）

### 鼠标操作

- **单击复选框**: 选中/取消单个端口
- **点击全选框**: 全选/取消全选
- **Shift + 点击**: 连续选择（未来计划）

---

## 注意事项

### ⚠️ 安全提示

1. **谨慎使用全选**
   - 使用筛选器限定范围后再全选
   - 确认选中的端口列表
   - 避免误关闭系统关键服务

2. **数据库服务**
   - 批量关闭数据库前确保没有重要应用依赖
   - 建议使用"永久停止"
   - 检查是否有未保存的数据

3. **系统服务**
   - 批量关闭系统服务可能影响系统稳定性
   - 谨慎选择要关闭的系统进程
   - 了解每个进程的作用

### ✅ 最佳实践

1. **使用筛选器**
   ```
   先筛选 → 再批量选择 → 最后关闭
   ```
   - 使用"进程类型"筛选器
   - 使用"开发进程"筛选器
   - 使用"端口类型"筛选器

2. **分批操作**
   - 将大量端口分批关闭
   - 每批 5-10 个端口
   - 观察每批的执行结果

3. **验证结果**
   ```
   关闭后 → 刷新页面 → 确认端口已释放
   ```

4. **记录操作**
   ```bash
   # 查看批量操作日志
   tail -f app.log | grep "Batch"
   ```

---

## 常见问题

### Q1: 为什么有些端口没有复选框？

**A**: 只有有 PID 的进程才能被关闭，因此只有这些端口显示复选框。监听端口但没有进程信息的不显示复选框。

### Q2: 批量关闭失败怎么办？

**A**: 查看具体的失败原因：
- 进程已经不存在
- 权限不足
- 服务被保护无法关闭

可以查看日志：
```bash
tail -50 app.log | grep "Batch\|ERROR"
```

### Q3: 批量操作后端口还在怎么办？

**A**: 
1. 等待 2 秒让系统完成关闭
2. 手动刷新页面
3. 检查是否选择了"永久停止"
4. 查看操作结果中的失败信息

### Q4: 可以一次关闭所有端口吗？

**A**: 技术上可以，但**不推荐**：
- 可能关闭系统关键服务
- 可能关闭 Port Manager 自己（端口 9527）
- 建议使用筛选器限定范围

### Q5: 批量永久停止后如何重启服务？

**A**: 使用 Homebrew 命令：
```bash
# 批量启动服务
brew services start mysql redis postgresql

# 或逐个启动
brew services start mysql
brew services start redis
```

---

## 性能说明

### 处理速度

- **并发处理**: 后端串行处理每个进程
- **平均速度**: 约 0.1-0.5 秒/进程
- **建议批量**: 一次不超过 20 个进程

### 超时时间

- **单个进程**: 10 秒
- **批量操作**: 根据数量自动调整
- **前端超时**: 30 秒

---

## 日志查看

### 实时查看批量操作

```bash
tail -f app.log | grep -i "batch\|kill"
```

### 查看操作结果

```bash
grep "Batch kill completed" app.log | tail -10
```

### 查看失败记录

```bash
grep "Batch.*failed\|Failed to kill" app.log
```

---

## 示例脚本

### 批量关闭开发端口 (3000-4000)

```bash
# 获取端口列表
PIDS=$(curl -s http://localhost:9527/api/ports | \
  jq -r '.data[] | select(.port >= 3000 and .port <= 4000) | .pid')

# 构造JSON数组
PID_ARRAY=$(echo "$PIDS" | jq -s '.')

# 批量关闭
curl -X DELETE "http://localhost:9527/api/process/batch" \
  -H "Content-Type: application/json" \
  -d "{\"pids\": $PID_ARRAY, \"permanent\": false}"
```

### 批量关闭所有数据库

```bash
# 获取数据库进程
PIDS=$(curl -s http://localhost:9527/api/ports | \
  jq -r '.data[] | select(.processType == "DATABASE") | .pid')

# 批量永久停止
curl -X DELETE "http://localhost:9527/api/process/batch" \
  -H "Content-Type: application/json" \
  -d "{\"pids\": $(echo "$PIDS" | jq -s '.'), \"permanent\": true}"
```

---

## 技术实现

### 前端实现

- **选择管理**: Set 数据结构存储选中的 PID
- **状态同步**: 实时更新按钮和复选框状态
- **批量请求**: 一次 HTTP DELETE 请求

### 后端实现

- **串行处理**: 逐个处理每个进程
- **错误隔离**: 单个失败不影响其他进程
- **结果聚合**: 统计成功和失败数量

### API 端点

```
DELETE /api/process/batch
Content-Type: application/json
Body: { "pids": [number[]], "permanent": boolean }
```

---

## 版本历史

- **v1.0** - 2026-02-08: 初始版本，支持基本的批量关闭功能

---

**应用地址**: http://localhost:9527  
**文档更新**: 2026-02-08
